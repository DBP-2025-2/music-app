<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title><%= title %></title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f1f1; padding-bottom: 10px; }
        h3 { margin: 0; color: #444; font-size: 1.1rem; }

        .form-group { display: flex; gap: 10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; flex: 1; font-size: 0.95rem; }
        
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-danger { background-color: #ff4d4d; color: white; font-size: 0.8rem; padding: 6px 12px; }
        .btn-danger:hover { background-color: #cc0000; }
        .btn-refresh { background-color: transparent; color: #666; font-size: 1.2rem; padding: 5px; }
        .btn-refresh:hover { color: #007bff; background-color: #f1f1f1; border-radius: 50%; }


        ul { list-style: none; padding: 0; margin: 0; }
        li { background: #fff; border-bottom: 1px solid #eee; padding: 15px 5px; display: flex; justify-content: space-between; align-items: center; }
        li:last-child { border-bottom: none; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; color: white; font-weight: bold; margin-right: 12px; letter-spacing: 0.5px; }
        .badge.user { background-color: #20c997; }
        .badge.artist { background-color: #7950f2; } 
        
        .empty-msg { text-align: center; color: #aaa; padding: 30px; font-style: italic; }
    </style>
</head>
<body>

    <h1>ğŸµ Follow Manager</h1>

    <div class="card">
        <div class="card-header">
            <h3>â• íŒ”ë¡œìš° í•˜ê¸°</h3>
        </div>
        <div class="form-group">
            <select id="targetType" style="flex: 0.3;" onchange="toggleInputPlaceholder()">
                <option value="user">ìœ ì €</option>
                <option value="artist">ì•„í‹°ìŠ¤íŠ¸</option>
            </select>
            <input type="text" id="targetInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
            <button class="btn-primary" onclick="followTarget()">ì¶”ê°€</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>ğŸ“‹ íŒ”ë¡œìš° ëª©ë¡</h3>
            <button class="btn-refresh" onclick="loadFollows()" title="ìƒˆë¡œê³ ì¹¨">â†»</button>
        </div>
        <ul id="followList">
            <li class="empty-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
        </ul>
    </div>

    <script>
        const API_URL = '/api/follows';

        // ì…ë ¥ì°½ íŒíŠ¸ ìë™ ë³€ê²½
        function toggleInputPlaceholder() {
            const type = document.getElementById('targetType').value;
            const input = document.getElementById('targetInput');
            input.placeholder = type === 'user' ? "ìƒëŒ€ë°© ë‹‰ë„¤ì„ (ì˜ˆ: í…ŒìŠ¤íŠ¸ìœ ì €2)" : "ì•„í‹°ìŠ¤íŠ¸ ì´ë¦„ (ì˜ˆ: NewJeans)";
        }

        // ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° 
        async function loadFollows() {
            const listEl = document.getElementById('followList');
            try {
                const res = await fetch(`${API_URL}/list`);
                const data = await res.json();

                listEl.innerHTML = ''; 

                if (!data.follows || data.follows.length === 0) {
                    listEl.innerHTML = '<li class="empty-msg">íŒ”ë¡œìš°í•œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    return;
                }

                data.follows.forEach(item => {
                    const li = document.createElement('li');
                    const typeClass = item.target_type === 'user' ? 'user' : 'artist';
                    const displayName = item.target_name ? item.target_name : `ID: ${item.following_id}`;

                    li.innerHTML = `
                        <div>
                            <span class="badge ${typeClass}">${item.target_type.toUpperCase()}</span>
                            <strong style="color:#333; font-size:1.05rem;">${displayName}</strong>
                        </div>
                        <button class="btn-danger" onclick="unfollow('${item.following_id}', '${item.target_type}')">ì‚­ì œ</button>
                    `;
                    listEl.appendChild(li);
                });
            } catch (err) {
                listEl.innerHTML = '<li class="empty-msg" style="color:red">ì„œë²„ ì—°ê²° ì‹¤íŒ¨</li>';
            }
        }

        // íŒ”ë¡œìš° ìš”ì²­
        async function followTarget() {
            const targetType = document.getElementById('targetType').value;
            const targetInput = document.getElementById('targetInput').value;

            if (!targetInput.trim()) return alert("ëŒ€ìƒì„ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_input: targetInput, target_type: targetType })
                });
                
                const result = await res.json();
                if (res.ok) {
                    loadFollows(); // ì„±ê³µ ì‹œ ëª©ë¡ ìë™ ê°±ì‹ 
                    document.getElementById('targetInput').value = ''; 
                } else {
                    alert(result.message);
                }
            } catch (err) {
                alert("ì„œë²„ ì˜¤ë¥˜");
            }
        }

        // ì–¸íŒ”ë¡œìš° ìš”ì²­
        async function unfollow(followingId, targetType) {
            if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            try {
                const res = await fetch(API_URL, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ following_id: followingId, target_type: targetType })
                });
                if (res.ok) loadFollows();
            } catch (err) {
                alert("ì˜¤ë¥˜ ë°œìƒ");
            }
        }
        
        // ì‹œì‘í•˜ìë§ˆì ì‹¤í–‰
        window.onload = () => {
            toggleInputPlaceholder();
            loadFollows(); 
        };
    </script>
</body>
</html>